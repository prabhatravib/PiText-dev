<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PiText</title>
  <link rel="icon" href="/PiText_favicon.ico" type="image/x-icon"/>

  <!-- Mermaid UMD build (gives a global `mermaid`) -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

  <!-- ==========  ALL CSS  ========== -->
  <style>
    /* ---- layout / background ---- */
    body{
      background:#000 url("/PiText_background.png") center/100% auto no-repeat fixed;
      color:#f0f0f0;font-family:sans-serif;margin:2rem;text-align:center;min-height:100vh;
    }
    h1{margin-bottom:2rem;color:#fff;text-shadow:0 0 8px rgba(0,0,0,.8);}    
    input{padding:.5rem;font-size:1rem;width:300px;margin-right:.5rem;}
    button{padding:.5rem 1rem;font-size:1rem;cursor:pointer;}
    #result{
      margin:2rem auto;border:1px solid rgba(255,255,255,.3);border-radius:4px;
      padding:2rem;min-height:50vh;max-width:90vw;
      background:rgba(255,255,255,.1);backdrop-filter:blur(2px);text-align:center;
    }

    /* ---- selection indicator (shows after you click a node) ---- */
    .selection-indicator{
      display:none;margin:1rem auto;padding:1rem;
      background:rgba(0,0,0,.8);color:#fff;border-radius:8px;max-width:600px;font-size:14px;
    }
    .selection-indicator.active{display:block;}
    .selection-display{margin-bottom:1rem;padding-bottom:.5rem;border-bottom:1px solid rgba(255,255,255,.3);}    
    .deep-dive-input{display:flex;gap:.5rem;align-items:center;}
    .deep-dive-input input{
      flex:1;padding:.5rem;font-size:14px;background:rgba(255,255,255,.1);
      border:1px solid rgba(255,255,255,.3);color:#fff;border-radius:4px;
    }
    .deep-dive-input input::placeholder{color:rgba(255,255,255,.6);}    
    .deep-dive-input button{
      padding:.5rem 1rem;font-size:14px;background:rgba(255,255,255,.2);color:#fff;
      border:1px solid rgba(255,255,255,.3);border-radius:4px;transition:background .2s;
    }
    .deep-dive-input button:hover{background:rgba(255,255,255,.3);}    

    /* ---- deep-dive response ---- */
    .deep-dive-response{
      display:none;margin:1rem auto;padding:1.5rem;background:rgba(0,0,0,.7);
      color:#fff;border-radius:8px;max-width:800px;font-size:14px;line-height:1.6;text-align:left;
    }
    .deep-dive-response.active{display:block;}
    .deep-dive-response h3{margin:0 0 .5rem;font-size:16px;}
    .deep-dive-response .question{font-style:italic;margin-bottom:1rem;opacity:.8;}
    .deep-dive-response .answer{white-space:pre-wrap;}

    /* ---- mermaid tweaks: arrows and fonts ---- */
    .mermaid text{cursor:text;user-select:text;text-shadow:1px 1px 2px rgba(255,255,255,.8)!important;}
    .mermaid .nodeLabel{filter:drop-shadow(0 0 3px rgba(255,255,255,.9))!important;}
    .mermaid .edgePath path,
    .mermaid .flowchart-link,
    .mermaid path.path,
    .mermaid g.edgePath path,
    .mermaid g.edgePaths path{
      stroke:#000!important;stroke-width:4px!important;fill:none!important;
      filter:drop-shadow(0 0 3px rgba(255,255,255,.9)) drop-shadow(0 0 6px rgba(255,255,255,.8))!important;
    }
    .mermaid .arrowheadPath,
    .mermaid .arrowhead path,
    .mermaid marker path,
    .mermaid marker polygon{
      fill:#000!important;stroke:#fff!important;stroke-width:2px!important;
      filter:drop-shadow(0 0 2px rgba(255,255,255,.9))!important;
    }

    /* ---- hover highlight: scale the whole node ---- */
    .mermaid g.node:hover {
      transform:scale(1.08);
      transform-origin:center;
      transition:transform 120ms;
      /* Safari 14–15 fix */
      transform-box:fill-box;
    }
    .mermaid g.node:hover rect{stroke-width:3px!important;}

    /* ---- “selected” class (after click) ---- */
    .node-selected rect,
    .node-selected circle,
    .node-selected ellipse,
    .node-selected polygon{stroke-width:3px!important;}
    .node-selected text,
    .node-selected tspan,
    .node-selected .nodeLabel{font-weight:bold!important;font-size:15px!important;}
  </style>
</head>
<body>
  <h1>Text Responses, using Pictures!</h1>
  <input id="query" placeholder="Ask anything!"/>
  <button id="generateBtn">Generate</button>

  <div id="result">Your diagram will appear here.</div>

  <!-- === selection / deep-dive UI === -->
  <div id="selectionIndicator" class="selection-indicator">
    <div class="selection-display">
      <strong>Selected:</strong> <span id="selectedText"></span>
    </div>
    <div class="deep-dive-input">
      <input id="deepDiveQuery" placeholder="Ask about this selection…"/>
      <button id="askBtn">Ask</button>
    </div>
  </div>
  <div id="deepDiveResponse" class="deep-dive-response"></div>

  <!-- ==========  JS ========== -->
  <script>
    mermaid.initialize({ startOnLoad:false });

    /* ---------- state ---------- */
    let selectedElement=null, selectedText='', currentQuery='';

    /* ---------- UI wiring ---------- */
    document.getElementById('generateBtn').onclick = generateDiagram;
    document.getElementById('askBtn').onclick      = askAboutSelection;
    document.getElementById('deepDiveQuery')
            .addEventListener('keypress',e=>{ if(e.key==='Enter') askAboutSelection(); });

    /* ---------- generate diagram ---------- */
    async function generateDiagram(){
      const q=document.getElementById('query').value.trim();
      const res=document.getElementById('result');
      if(!q){res.textContent='Please enter a query.';return;}
      currentQuery=q;
      resetSelection();

      res.textContent='Generating…';
      try{
        const r=await fetch('/describe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:q})});
        const data=await r.json();
        if(!data.success) throw new Error(data.detail||'Unknown error');

        res.innerHTML=`<div class="mermaid">${data.diagram}</div>`;
        mermaid.init(undefined,res.querySelector('.mermaid'));

        /* wait a tick so SVG exists, then post-process */
        setTimeout(()=>{forceArrowVisibility(res);setupTextSelection(res);},50);
      }catch(err){res.textContent=`Error: ${err.message}`;}
    }

    /* ---------- node / edge clicks ---------- */
    function setupTextSelection(container){
      const svg=container.querySelector('svg'); if(!svg) return;

      /* node click */
      svg.querySelectorAll('g.node').forEach(node=>{
        node.style.cursor='pointer';
        node.onclick=()=>{
          selectElement(node,extractNodeText(node));
        };
      });

      /* edge-label click */
      svg.querySelectorAll('.edgeLabel').forEach(lbl=>{
        lbl.style.cursor='pointer';
        lbl.onclick=e=>{
          e.stopPropagation();
          selectElement(lbl,lbl.textContent.trim());
        };
      });

      /* blank click clears selection */
      svg.onclick=e=>{
        if(e.target===svg){
          resetSelection();
        }
      };
    }

    function selectElement(el,text){
      if(selectedElement) selectedElement.classList.remove('node-selected');
      el.classList.add('node-selected');
      selectedElement=el; selectedText=text||'';
      document.getElementById('selectedText').textContent=selectedText;
      document.getElementById('selectionIndicator').classList.add('active');
      document.getElementById('deepDiveQuery').focus();
    }

    function resetSelection(){
      if(selectedElement) selectedElement.classList.remove('node-selected');
      selectedElement=null; selectedText='';
      document.getElementById('selectionIndicator').classList.remove('active');
      document.getElementById('deepDiveQuery').value='';
      document.getElementById('deepDiveResponse').classList.remove('active');
    }

    /* extract text inside a node */
    function extractNodeText(node){
      let t=''; const textEl=node.querySelector('text');
      if(textEl){
        const ts=textEl.querySelectorAll('tspan');
        t=ts.length?Array.from(ts).map(x=>x.textContent.trim()).filter(Boolean).join(' '):textEl.textContent.trim();
      }
      if(!t){
        const lbl=node.querySelector('.nodeLabel'); if(lbl) t=lbl.textContent.trim();
      }
      return t;
    }

    /* ---------- deep-dive ---------- */
    async function askAboutSelection(){
      const q=document.getElementById('deepDiveQuery').value.trim();
      if(!q||!selectedText) return;
      const respDiv=document.getElementById('deepDiveResponse');
      respDiv.innerHTML='<div>Thinking…</div>';
      respDiv.classList.add('active');

      try{
        const r=await fetch('/deep-dive',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({selected_text:selectedText,question:q,original_query:currentQuery})
        });
